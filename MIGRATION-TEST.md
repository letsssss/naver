# Supabase 마이그레이션 테스트 가이드

## 준비 사항

1. **로그 디렉토리 생성**
   ```
   mkdir -p logs
   ```

2. **환경 변수 확인**
   `.env.local` 파일에 다음 환경 변수가 올바르게 설정되어 있는지 확인하세요:
   ```
   NEXT_PUBLIC_SUPABASE_URL=https://jdubrjczdyqqtsppojgu.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```

## 테이블 생성

Supabase 대시보드에서 SQL 에디터를 열고 다음 스크립트를 실행하세요:

1. **SQL 스크립트 실행**
   ```sql
   -- Supabase 테이블 생성 스크립트

   -- 1. 사용자 테이블 (auth.users 테이블은 이미 Supabase에서 제공)
   CREATE TABLE IF NOT EXISTS public.users (
     id UUID PRIMARY KEY REFERENCES auth.users(id),
     email TEXT UNIQUE NOT NULL,
     name TEXT,
     role TEXT DEFAULT 'USER',
     profile_image TEXT,
     phone_number TEXT,
     bank_info JSONB,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
   );

   -- 2. 게시물 테이블
   CREATE TABLE IF NOT EXISTS public.posts (
     id BIGINT PRIMARY KEY,
     title TEXT NOT NULL,
     content TEXT,
     price INTEGER,
     status TEXT DEFAULT 'ACTIVE',
     user_id UUID REFERENCES public.users(id),
     created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
   );

   -- 3. 알림 테이블
   CREATE TABLE IF NOT EXISTS public.notifications (
     id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
     user_id UUID REFERENCES public.users(id),
     post_id BIGINT REFERENCES public.posts(id),
     message TEXT NOT NULL,
     type TEXT NOT NULL,
     is_read BOOLEAN DEFAULT FALSE,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
   );
   ```

## 마이그레이션 실행

1. **마이그레이션 스크립트 실행**
   ```
   pnpm migrate:to:supabase
   ```
   또는
   ```
   node --loader ts-node/esm scripts/migrate-to-supabase.ts
   ```
   또는
   ```
   node lib/scripts/migrate-data.js
   ```

2. **로그 확인**
   마이그레이션 로그가 `logs` 디렉토리에 저장됩니다. 로그를 확인하여 마이그레이션 상태를 점검하세요.

## 테스트 계획

마이그레이션 완료 후 다음 항목을 테스트하세요:

### 1. API 엔드포인트 테스트

1. **알림 API 테스트**
   ```
   curl -X GET http://localhost:3000/api/notifications
   ```

2. **게시물 API 테스트**
   ```
   curl -X GET http://localhost:3000/api/posts
   ```

3. **사용자 API 테스트**
   ```
   curl -X GET http://localhost:3000/api/auth/me -H "Authorization: Bearer YOUR_JWT_TOKEN"
   ```

### 2. 실시간 기능 테스트

1. 애플리케이션을 실행하세요: `pnpm dev`
2. 브라우저에서 `http://localhost:3000`에 접속하세요
3. 알림 컴포넌트가 정상적으로 표시되는지 확인하세요
4. 새로운 알림을 생성하고 실시간으로 업데이트되는지 확인하세요

### 3. 데이터 확인

Supabase 대시보드에서 다음을 확인하세요:

1. 사용자 데이터가 올바르게 마이그레이션되었는지 확인하세요
2. 게시물 데이터가 올바르게 마이그레이션되었는지 확인하세요
3. 알림 데이터가 올바르게 마이그레이션되었는지 확인하세요

## 오류 해결

1. **"column X does not exist" 오류**
   - 이 오류는 Supabase 테이블의 열 이름이 스크립트에서 사용하는 이름과 일치하지 않을 때 발생합니다.
   - Supabase는 `snake_case`를 사용하고 Prisma는 `camelCase`를 사용하는 경우가 많습니다.
   - 마이그레이션 스크립트를 수정하여 열 이름을 일치시키세요.

2. **인증 오류**
   - Supabase URL 또는 키가 올바르게 설정되었는지 확인하세요.
   - 서비스 롤 키가 올바른지 확인하세요.

3. **데이터 변환 오류**
   - 데이터 타입을 확인하고 필요한 경우 변환하세요 (예: BigInt -> 문자열).
   - JSON 데이터가 올바르게 직렬화되었는지 확인하세요.

## 롤백 절차

문제가 발생한 경우 다음 단계로 롤백하세요:

1. Supabase 테이블 데이터 삭제:
   ```sql
   TRUNCATE TABLE notifications;
   TRUNCATE TABLE posts;
   TRUNCATE TABLE users CASCADE;
   ```

2. 애플리케이션에서 Prisma 폴백 메커니즘을 계속 사용하세요. 